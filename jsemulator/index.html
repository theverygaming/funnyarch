<!DOCTYPE html>
<html>

<head>
    <script src="computer.js"></script>
    <script src="cpu.js"></script>
    <script>
        class textAreaSerialConsole {
            constructor(element, onInput) {
                this.onInput = onInput;
                this.element = element;
                this.text = "";
                addEventListener('input', this.#evInput.bind(this));
            }

            addText(str) {
                for (let i = 0; i < str.length; i++) {
                    const char = str.charAt(i);
                    if (char == String.fromCharCode(8)) { // ASCII 8 -> backspace
                        this.text = this.text.slice(0, this.text.length - 1);
                    } else {
                        this.text += char;
                    }
                }
                if (this.text.length > 4000) {
                    this.text = this.text.slice(Math.floor(this.text.length / 2), this.text.length);
                }
                this.#resetValue();
            }

            #moveCursorToEnd() {
                this.element.scrollTop = this.element.scrollHeight;
                this.element.selectionStart = this.element.selectionEnd = this.element.value.length;
            }

            #resetValue() {
                this.element.value = this.text;
                this.#moveCursorToEnd();
            }

            #evInput(event) {
                if ((this.element.value.length >= this.text) || (this.element.value.slice(0, this.text.length) === this.text)) {
                    let inpStr = this.element.value.slice(this.text.length);
                    this.onInput(inpStr);
                } else {
                    // TODO: handle multiple backspaces
                    // try to handle single backspace
                    if (this.element.value.slice(0, this.text.length - 1) === this.text.slice(0, this.text.length - 1)) {
                        this.onInput(String.fromCharCode(8)); // ASCII 8 -> backspace
                    }
                }
                this.#resetValue();
            }
        }

        window.onload = function () {
            fetch('output.bin')
                .then(response => response.arrayBuffer())
                .then((rawdata) => {
                    const serialcon = new textAreaSerialConsole(document.getElementById("serialTextArea"), (str) => {
                        computer.serialIn(str);
                    });

                    let rom = new Uint8Array(8192);
                    rom.set(new Uint8Array(rawdata));
                    const computer = new funnyarchComputer(rom, new Uint8Array(4096), serialcon.addText.bind(serialcon), document.getElementById("screen"));

                    function runPuter() {
                        computer.run(10000);
                        window.requestAnimationFrame(runPuter);
                    }
                    window.requestAnimationFrame(runPuter);
                });
        }
    </script>
</head>

<body>
    <canvas id="screen" width="640" height="480"></canvas>
    <br>
    <textarea id="serialTextArea"
        style="font-family:monospace;background-color: black;color: white;width: 640px;height: 480px;"></textarea>
</body>

</html>
